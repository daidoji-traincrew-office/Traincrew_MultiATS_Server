name: Master Data Update

on:
  workflow_dispatch:

env:
  DATA_DIR: Traincrew_MultiATS_Server.Crew/Data
  TZ: Asia/Tokyo

jobs:
  update-master-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Generate GitHub App Token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.token }}

      - name: Set branch name
        id: branch
        run: |
          BRANCH_NAME="master_update/$(date +'%Y%m%d')"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create or pull branch
        run: |
          git checkout -b ${{ steps.branch.outputs.name }} || git checkout ${{ steps.branch.outputs.name }}
          git pull --no-rebase origin ${{ steps.branch.outputs.name }} || true

      - name: Set up Node.js
        uses: actions/setup-node@v4.4.0
        with:
          node-version: '20'

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2.1.13
        with:
          project_id: ${{ secrets.GOOGLE_PROJECT_ID }}
          service_account: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          workload_identity_provider: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2.2.1

      - name: Install dependencies
        run: npm install @googleapis/sheets google-auth-library

      - name: Export spreadsheets to CSV
        run: node .github/scripts/export-master-data.js
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
          RENDO_SPREADSHEET_ID: ${{ secrets.RENDO_SPREADSHEET_ID }}
          MASTER_SPREADSHEET_ID: ${{ secrets.MASTER_SPREADSHEET_ID }}

      - name: Commit and push
        run: |
          git add ${{ env.DATA_DIR }}
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "ãƒžã‚¹ã‚¿ãƒ¼æ›´æ–° $(date +'%Y%m%d')"
          git push -u origin ${{ steps.branch.outputs.name }}

      - name: Check if PR exists
        id: check_pr
        run: |
          PR_EXISTS=$(gh pr list --head ${{ steps.branch.outputs.name }} --json number --jq 'length')
          echo "exists=$PR_EXISTS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: steps.check_pr.outputs.exists == '0'
        run: |
          gh pr create \
            --title "ãƒžã‚¹ã‚¿ãƒ¼æ›´æ–° $(date +'%Y%m%d')" \
            --reviewer Kesigomon,${{ github.actor }} \
            --base ${{ github.ref_name }} \
            --body "$(cat <<'EOF'
          ## æ¦‚è¦
          Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒžã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚

          ## ç¢ºèªäº‹é …
          @${{ github.actor }}
          ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã€Approveã‚’ã—ã¦ãã ã•ã„ã€‚
          - [ ] å·®åˆ†ã‚’ç¢ºèªã€‚æ„å›³é€šã‚Šã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºã‹ã‚ã‚‹ã€‚
          - [ ] UT,ITãŒæ­£å¸¸ã«é€šéŽã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹

          ðŸ¤– Generated by GitHub Actions
          EOF
          )"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
