# 01_環境構築ガイド

## 概要

このドキュメントでは、Traincrew_MultiATS_Server プロジェクトの開発環境を構築する手順を説明します。

---

## 1. 前提条件

開発を始める前に、以下のツールをインストールしてください。

### 1.1 必須ツール

| ツール                                   | バージョン | 用途 | インストール先                                                |
|---------------------------------------|-----------|------|--------------------------------------------------------|
| **.NET 8.0 SDK**                      | 8.0 以上 | アプリケーション開発・ビルド | https://dotnet.microsoft.com/ja-jp/download/dotnet/8.0 |
| **Docker Engine(Docker Desktopは非推奨)** | 最新版 | PostgreSQL コンテナ実行 | https://docs.docker.jp/linux/step_one.html             |
| **Atlas CLI**                         | 最新版 | データベースマイグレーション管理 | https://atlasgo.io/getting-started                     |

### 1.2 推奨IDE

以下のいずれかを推奨します：

- **JetBrains Rider** (推奨)
- **Visual Studio 2022**
- **Visual Studio Code** + C# Dev Kit

---

## 2. 初回セットアップ手順

### 2.1 リポジトリのクローン

```bash
git clone https://github.com/daidoji-traincrew-office/Traincrew_MultiATS_Server
cd Traincrew_MultiATS_Server
```

### 2.2 PostgreSQL の起動

Docker Compose を使用してPostgreSQLコンテナを起動します。

```bash
cd Database
docker compose up -d
```

**確認方法:**
```bash
docker ps
# CONTAINER ID   IMAGE           COMMAND                  PORTS
# xxxxxxxxxx     postgres:16.4   "docker-entrypoint.s…"   0.0.0.0:5432->5432/tcp
```

### 2.3 データベースマイグレーションの適用

Atlas CLI を使用してデータベーススキーマを構築します。

```bash
# Database ディレクトリ内で実行
atlas migrate apply --env local
```

実行後、以下のようなメッセージが表示されれば成功です：
```
Migrating to version 20251220142915 (74 migrations in total):
  -- ... (マイグレーション適用ログ)
  -- All migrations applied successfully
```

### 2.4 初期データ投入

初期データ(連動図表データなど)は、サーバー初回起動時に `InitDbHostedService` によって自動的に投入されます。
手動で実行する必要はありません。

初期データの内容：
- `Traincrew_MultiATS_Server.Crew/Data/RendoTable/*.csv`
  - TTC列番窓.csv
  - TTC列番窓リンク設定.csv
  - 運転告知器.csv
  - 駅・停車場.csv
  - 軌道回路に対する計算するべき信号機リスト.csv
  - 種別.csv
  - 信号リスト.csv
  - 進路.csv
  - 総括制御ペア一覧.csv
  - 列車.csv

### 2.5 プロジェクトのビルド

ルートディレクトリに戻り、ソリューション全体をビルドします。

```bash
cd ..
dotnet build
```

ビルド成功時：
```
Build succeeded.
    0 Warning(s)
    0 Error(s)
```

### 2.6 サーバーの起動

#### 乗務員サーバー（Crew）の起動

```bash
cd Traincrew_MultiATS_Server.Crew
dotnet run -lp https
```

起動後、以下のようなログが表示されます：
```
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: https://localhost:5001
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
```

Swagger UI アクセス先：
- https://localhost:5001/swagger

#### お客様向けサーバー（Passenger）の起動(Optional)

別のターミナルを開いて実行します。

```bash
cd Traincrew_MultiATS_Server.Passenger
dotnet run -lp https
```

Swagger UI アクセス先：
- https://localhost:5002/swagger （ポート番号は appsettings.json で確認）

---

## 3. 開発環境設定

### 3.1 appsettings.Development.json

開発環境用の設定ファイルです。以下の項目を確認・調整してください。

**Crew プロジェクト例:**
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Database=postgres;Username=postgres;Password=postgres"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft.AspNetCore": "Information"
    }
  },
  "EnableAuthorization": false
}
```

#### 主要設定項目

| 設定項目 | 説明 | 開発時推奨値 |
|---------|------|-------------|
| `ConnectionStrings.DefaultConnection` | PostgreSQL 接続文字列 | `Host=localhost;Database=postgres;Username=postgres;Password=postgres` |
| `EnableAuthorization` | 認証の有効化 | `false` （開発時は無効化可能） |
| `Logging.LogLevel.Default` | デフォルトログレベル | `Debug` または `Information` |

### 3.2 ログレベルの調整

必要に応じて、以下のログレベルを設定できます：

- `Trace`: 最も詳細（パフォーマンスに影響）
- `Debug`: デバッグ情報（開発時推奨）
- `Information`: 一般的な情報
- `Warning`: 警告のみ
- `Error`: エラーのみ
- `Critical`: クリティカルエラーのみ

---

## 4. トラブルシューティング

### 4.1 PostgreSQL に接続できない

**症状:**
```
Npgsql.NpgsqlException: Failed to connect to localhost:5432
```

**解決方法:**

1. Docker コンテナが起動しているか確認
   ```bash
   docker ps
   ```

2. コンテナが起動していない場合、再起動
   ```bash
   cd Database
   docker compose up -d
   ```

3. ポート 5432 が他のプロセスで使用されていないか確認
   ```bash
   # Windows
   netstat -ano | findstr :5432

   # macOS/Linux
   lsof -i :5432
   ```

### 4.2 マイグレーションエラー

**症状:**
```
Error: migration file xxx is missing or corrupt
```

**解決方法:**

データベースコンテナを消すことで、データベースをリセットします

```bash
cd Database

# コンテナを再作成
docker compose down -v
docker compose up -d

# マイグレーション再適用
atlas migrate apply --env local
```

### 4.3 ポート衝突エラー

**症状:**
```
Failed to bind to address https://localhost:5001: address already in use
```

**解決方法:**

1. 既存のプロセスを停止
2. または、`appsettings.Development.json` でポート番号を変更

```json
{
  "Kestrel": {
    "Endpoints": {
      "Https": {
        "Url": "https://localhost:6001"
      }
    }
  }
}
```

### 4.4 ビルドエラー

**症状:**
```
error CS0246: The type or namespace name 'XXX' could not be found
```

**解決方法:**

1. NuGet パッケージを復元
   ```bash
   dotnet restore
   ```

2. ビルドキャッシュをクリア
   ```bash
   dotnet clean
   dotnet build
   ```

### 4.5 初期データが投入されない

**症状:**
- データベースにテーブルは作成されるが、データが空

**解決方法:**

1. `InitDbHostedService` のログを確認
   ```
   info: Traincrew_MultiATS_Server.HostedService.InitDbHostedService[0]
         Database initialization started.
   ```

2. CSV ファイルが存在するか確認
   ```bash
   ls Traincrew_MultiATS_Server.Crew/Data/RendoTable/
   ```

3. サーバーを再起動して再実行

---

## 5. 次のステップ

環境構築が完了したら、以下のドキュメントを参照してください：

- **02_アーキテクチャ設計.md**: プロジェクト構成と設計思想
- **03_コーディング規約.md**: コーディングルールとベストプラクティス
- **05_テスト戦略.md**: テストの書き方と実行方法
- **06_Hub実装チュートリアル.md**: Hub実装の流れ

---

## 6. 参考リンク

- [.NET 8 公式ドキュメント](https://learn.microsoft.com/dotnet/core/whats-new/dotnet-8)
- [Entity Framework Core](https://learn.microsoft.com/ef/core/)
- [Atlas CLI Documentation](https://atlasgo.io/)
- [Docker Compose Reference](https://docs.docker.com/compose/)
- [ASP.NET Core SignalR](https://learn.microsoft.com/aspnet/core/signalr/introduction)
